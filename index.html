<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js ie6 ie6-8 ie6-7" lang="en"><![endif]-->
<!--[if IE 7]><html class="no-js ie7 ie6-8 ie6-7" lang="en"><![endif]-->
<!--[if IE 8]><html class="no-js ie8 ie6-8" lang="en"><![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html class="no-js" lang="en" ><!--<![endif]-->
<head>
	<meta charset="utf-8" />
	<title>Websocket chat</title>
	<style type="text/css">
	.box {
		padding: 10px;
	}

	#dialog {
		border: 1px solid #000;
	}

	.strong {
		font-weight: bold;
	}
	</style>
</head>
<body>
	<section>
		<h1>Chat</h1>
		<form>
			Type your message:
			<input type="text" id="input" placeholder="Type your message">
		</form>
		<div class="box" id="dialog"></div>	
		<div class="box" id="info"></div>
	</section>

	<script src="/socket.io/socket.io.js"></script>
	<script>
		var dialog = document.getElementById('dialog');
		var lastMessageElement = null;
		var input = document.getElementById('input');
		var infoElement = document.getElementById('info');

		var socket = io();
		socket.on('serverMessage', function(content) {
			addMessage(content);
		});

		//set username
		var username = prompt('What username would you like to use?');
		socket.emit('login', username);

		socket.on('logged', function(data) {
			console.log("user logged in");
			usersInfoUpdate(data)
		});
		socket.on('userJoined', function(data) {
			console.log("user joined");
			usersInfoUpdate(data)
		});
		socket.on('userLeft', function(data) {
			console.log("user left");
			usersInfoUpdate(data)
		});

		input.onkeydown = function(e) {
			if (e.keyCode === 13) {
				socket.emit('clientMessage', this.value);
				this.value = '';
				return false;
			} else {
				return true;
			}
		};

		function addMessage(message) {
			var newMessageElement = document.createElement('div');
			var newMessageText = document.createTextNode(message);

			newMessageElement.appendChild(newMessageText);
			dialog.insertBefore(newMessageElement, lastMessageElement);
			lastMessageElement = newMessageElement;
		}

		function usersInfoUpdate(data) {
			infoElement.innerHTML = "Currently " + data.usersCount + " users is logged in";
		}
	</script>

</body>
</html>